<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processando Login | Observatório Social RJ</title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        .callback-container { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; background:linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color:white; text-align:center; padding:20px; }
        .spinner { width:40px; height:40px; border:4px solid rgba(255,255,255,0.3); border-radius:50%; border-top-color:white; animation:spin 1s ease-in-out infinite; margin-bottom:20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .message { font-size:18px; margin-bottom:10px; }
        .submessage { font-size:14px; opacity:0.8; }
        .error { background:#ff4757; color:white; padding:15px; border-radius:8px; margin-top:20px; max-width:500px; }
        .retry-btn { background:white; color:var(--primary-color); border:none; padding:10px 20px; border-radius:6px; cursor:pointer; margin-top:15px; font-weight:600; }
    </style>
    <script>
      // Carregar config pública do Auth0 em produção, se necessário
      async function loadAuth0Config() {
        try {
          const isProduction = window.location.hostname.endsWith('netlify.app');
          if (isProduction) {
            const res = await fetch('/.netlify/functions/config');
            if (res.ok) {
              window.AUTH0_CONFIG = await res.json();
            }
          }
          if (!window.AUTH0_CONFIG || !window.AUTH0_CONFIG.AUTH0_CLIENT_ID) {
            window.AUTH0_CONFIG = {
              AUTH0_DOMAIN: 'dev-cvjwhtcjyx8zmows.us.auth0.com',
              AUTH0_CLIENT_ID: 'pIcBfUTnGTh7Du1trOtnYKJU4pH5zMUW'
            };
          }
        } catch (e) {}
      }
    </script>
</head>
<body>
    <div class="callback-container">
        <div class="spinner"></div>
        <div class="message">Processando seu login...</div>
        <div class="submessage">Aguarde enquanto configuramos sua conta.</div>
        <div id="error-message" class="error" style="display:none;">
            <div id="error-text"></div>
            <button class="retry-btn" onclick="window.location.href = '../pages/login.html'">Tentar Novamente</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@auth0/auth0-spa-js@2.1.3/dist/auth0-spa-js.production.js" crossorigin="anonymous"></script>
    <script src="https://cdn.auth0.com/js/auth0/9.23.0/auth0.min.js" crossorigin="anonymous"></script>
    <script>
      // Capture WebAuth constructor early to avoid global collisions
      window.Auth0WebAuthCtor = (window.auth0 && window.auth0.WebAuth) ? window.auth0.WebAuth : null;
    </script>
    <script src="../js/auth0-client.js"></script>
    <script>
      async function handle() {
        try {
          await loadAuth0Config();
          const client = Auth0Client.getInstance();
          // Tenta fluxo SPA (PKCE). Se falhar, usa WebAuth (implicit) como fallback
          try {
            await client.ensureInitialized();
            await client.handleRedirectCallback();
            const accessToken = await client.getAccessToken();
            const idToken = await client.getIdToken();
            const user = await client.getUser();
            await syncAndRedirect(user, accessToken, idToken);
            return;
          } catch (e) {
            // Fallback: tentar parseHash via WebAuth
            const WebAuthCtor = window.Auth0WebAuthCtor || (window.auth0 && window.auth0.WebAuth);
            if (WebAuthCtor) {
              const auth = new WebAuthCtor({
                domain: window.AUTH0_CONFIG.AUTH0_DOMAIN,
                clientID: window.AUTH0_CONFIG.AUTH0_CLIENT_ID,
                redirectUri: window.location.origin + '/pages/callback.html',
                responseType: 'token id_token',
                scope: 'openid profile email'
              });
              auth.parseHash(async (err, result) => {
                if (err || !result || !result.idToken) {
                  throw new Error('Erro no parseHash do Auth0');
                }
                localStorage.setItem('access_token', result.accessToken || '');
                localStorage.setItem('id_token', result.idToken);
                // Obter userinfo com accessToken
                auth.client.userInfo(result.accessToken, async (err2, user) => {
                  if (err2) throw err2;
                  await syncAndRedirect(user, result.accessToken, result.idToken);
                });
              });
              return;
            } else {
              throw e;
            }
          }
        } catch (err) {
          document.querySelector('.spinner').style.display = 'none';
          document.querySelector('.message').style.display = 'none';
          document.querySelector('.submessage').style.display = 'none';
          const d = document.getElementById('error-message');
          const t = document.getElementById('error-text');
          t.textContent = err && err.message ? err.message : 'Erro no processo de login';
          d.style.display = 'block';
        }
      }
      async function syncAndRedirect(user, accessToken, idToken){
        try {
          const resp = await fetch('/.netlify/functions/user-sync', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': accessToken ? `Bearer ${accessToken}` : undefined
            },
            body: JSON.stringify({ user, auth0Data: { idToken } })
          });
          if (resp.ok) {
            const userData = await resp.json();
            localStorage.setItem('current_user', JSON.stringify({ ...userData, loginTime: new Date().toISOString() }));
            if (!userData.approved && !userData.is_admin && !userData.is_root) {
              window.location.href = '../pages/pending-approval.html';
              return;
            }
            window.location.href = '../index.html';
            return;
          }
        } catch (e) {
          console.warn('User sync failed, proceeding with Auth0 user only:', e);
        }
        // Fallback: proceed without DB sync
        const fallback = {
          id: user.sub || user.user_id || 'auth0-user',
          email: user.email,
          name: user.name || user.nickname || (user.email || '').split('@')[0],
          role: 'visitante',
          isAdmin: false,
          isRoot: false,
          approved: true
        };
        localStorage.setItem('current_user', JSON.stringify({ ...fallback, loginTime: new Date().toISOString() }));
        window.location.href = '../index.html';
      }
      window.addEventListener('DOMContentLoaded', handle);
    </script>
</body>
</html>
